#!/usr/bin/env ruby
$:.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

developer_mode = false
developer_mode = true if __FILE__ == $0
require 'rubygems' if developer_mode

require 'validator'
require 'anemone'
require 'colorful_messages'
require 'validate_website'

include ColorfulMessages

validate_website = ValidateWebsite.new(ARGV)
options = validate_website.options

exit_code = 0

Anemone.crawl(options[:site],
              :user_agent => options[:useragent],
              :authorization => options[:auth]) do |anemone|

  anemone.skip_links_like Regexp.new(options[:exclude]) if options[:exclude]

  anemone.on_every_page { |page|
    url = page.url.to_s
    print info(url)

    # validate html/html+xml
    if page.html? && page.fetched?
      validator = Validator.new(page)
      msg = " well formed? %s" % validator.valid?
      if validator.valid?
        puts success(msg)
      else
        exit_code = 1
        puts error(msg)
        validate_website.to_file(url)
      end
    end

    if options[:not_found] && page.not_found?
      exit_code = 1
      puts error("%s linked in %s but not exist" % [url, page.referer])
      validate_website.to_file(url)
    end
  }
end

exit(exit_code)
